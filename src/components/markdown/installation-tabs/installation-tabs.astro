---
import { Code } from "@astrojs/starlight/components"
import { InstallationTabsInternal } from "./_installation-tabs-internal"
import CliCommandCode from "@/components/markdown/cli-command-code/cli-command-code.astro"
import { SERVER_URL } from "@/data/env"
import { ManualInstallCodeCard } from "@/components/manual-install-code-card"

interface RegistryItemSchema {
    files?: Array<{
        path: string;
        content?: string;
        target?: string;
        type: string;
    }>;
    dependencies?: string[];
    registryDependencies?: string[];
}

interface Props {
  registryItem: string
}

const { registryItem } = Astro.props

// Dynamic import of registry JSON
let module: RegistryItemSchema;
try {
  // @ts-ignore
  module = (await import(`../../../../public/r/${registryItem}.json`)).default as RegistryItemSchema
} catch (e) {
  console.error(`Failed to load registry item: ${registryItem}`, e)
  module = {}
}

function getFileLocationFromType(type: string) {
  switch (type) {
    case "registry:ui":
      return "src/components/ui"
    case "registry:page":
    case "registry:file":
       return "src/app" // fallback
    case "registry:component":
      return "src/components"
    case "registry:lib":
      return "src/lib"
    case "registry:hook":
      return "src/hooks"
    default:
      return "src/components/ui"
  }
}

const filesToCopy = module.files?.map(file => {
  const pathFromType = getFileLocationFromType(file.type as any)
  return {
    path: file.target ?? `${pathFromType}/${registryItem}.${file.path.split(".").pop()}`,
    displayPath: file.target ?? `${pathFromType}/${file.path.split('/').pop()}`,
    content: file.content ?? "",
    origPath: file.path
  }
})

const npmModulesToInstall = module.dependencies
const registryDependencies = module.registryDependencies
  ?.map(dep => {
    if (dep.startsWith("http")) {
      const name = dep.split("/").pop()?.split(".")[0]?.replace("-", " ")
      return {
        name,
        href: `${SERVER_URL}/components/${name}`,
      }
    } else {
      return {
        name: dep.replace("-", " "),
        href: `https://ui.shadcn.com/docs/components/${dep}`,
      }
    }
  })
  .filter(d => d.name != null)

---

<div>
  {/* @ts-expect-error: This component takes a cliSteps prop but the only way to pass that in with Astro is with a slot */}
  <InstallationTabsInternal client:load>
    <CliCommandCode
      slot="cliSteps"
      action="run"
      command={`shadcn@latest add ${SERVER_URL}/r/${registryItem}.json`}
    />

    <div class="flex flex-col gap-8">
      {
        registryDependencies != null && registryDependencies.length > 0 && (
          <div class="flex flex-col gap-4">
            <p>
              This component relies on other items which must be installed
              first.
            </p>
            <ul class="list-disc pl-10">
              {registryDependencies.map(dep => (
                <li>
                  <a
                    href={dep.href}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="capitalize underline underline-offset-3"
                  >
                    {dep.name}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )
      }
      {
        npmModulesToInstall != null && npmModulesToInstall.length > 0 && (
          <div class="flex flex-col gap-4">
            <p>Install the following dependencies.</p>
            <CliCommandCode
              action="install"
              command={npmModulesToInstall.join(" ")}
            />
          </div>
        )
      }
      {
        filesToCopy != null && filesToCopy.length > 0 && (
          <div class="flex flex-col gap-4">
            <p>Copy and paste the following code into your project.</p>
            {filesToCopy.map(file => (
              <ManualInstallCodeCard client:load filePath={file.displayPath}>
                 <Code code={file.content || "// Content not available"} lang="tsx" />
              </ManualInstallCodeCard>
            ))}
          </div>
        )
      }
      <p>Update the import paths to match your project setup.</p>
    </div>
  </InstallationTabsInternal>
</div>
